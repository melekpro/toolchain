[4.6/4.7 Regression] Cast to pointer to VLA crash the compiler

 http://gcc.gnu.org/bugzilla/show_bug.cgi?id=54552

--- gcc-4_6-branch/gcc/ChangeLog	2012/09/15 00:28:05	191336
+++ gcc-4_6-branch/gcc/ChangeLog	2012/09/15 00:29:28	191337
@@ -1,3 +1,10 @@
+2012-09-15  Joseph Myers  <joseph@codesourcery.com>
+
+	PR c/54552
+	* c-typeck.c (c_cast_expr): When casting to a type requiring
+	C_MAYBE_CONST_EXPR to be created, pass the inner expression to
+	c_fully_fold first.
+
 2012-09-03  Jakub Jelinek  <jakub@redhat.com>
 
 	Backported from mainline
--- gcc-4_6-branch/gcc/c-typeck.c	2012/09/15 00:28:05	191336
+++ gcc-4_6-branch/gcc/c-typeck.c	2012/09/15 00:29:28	191337
@@ -4761,8 +4761,11 @@
   ret = build_c_cast (loc, type, expr);
   if (type_expr)
     {
+      bool inner_expr_const = true;
+      ret = c_fully_fold (ret, require_constant_value, &inner_expr_const);
       ret = build2 (C_MAYBE_CONST_EXPR, TREE_TYPE (ret), type_expr, ret);
-      C_MAYBE_CONST_EXPR_NON_CONST (ret) = !type_expr_const;
+      C_MAYBE_CONST_EXPR_NON_CONST (ret) = !(type_expr_const
+					     && inner_expr_const);
       SET_EXPR_LOCATION (ret, loc);
     }
 
--- gcc-4_6-branch/gcc/testsuite/ChangeLog	2012/09/15 00:28:05	191336
+++ gcc-4_6-branch/gcc/testsuite/ChangeLog	2012/09/15 00:29:28	191337
@@ -1,3 +1,8 @@
+2012-09-15  Joseph Myers  <joseph@codesourcery.com>
+
+	PR c/54552
+	* gcc.c-torture/compile/pr54552-1.c: New test.
+
 2012-09-03  Jakub Jelinek  <jakub@redhat.com>
 
 	Backported from mainline
--- /dev/null
+++ gcc-4_6-branch/gcc/testsuite/gcc.c-torture/compile/pr54552-1.c	2012/09/15 00:29:28	191337
@@ -0,0 +1,8 @@
+void
+f (void)
+{
+  unsigned n = 10;
+
+  typedef double T[n];
+  (double (*)[n])((unsigned char (*)[sizeof (T)]){ 0 });
+}
