[4.4/4.5/4.6/4.7 regression] cc1plus hangs when compiling

http://gcc.gnu.org/bugzilla/show_bug.cgi?id=51344

--- gcc-4_4-branch/gcc/cp/ChangeLog	2012/01/19 22:57:31	183318
+++ gcc-4_4-branch/gcc/cp/ChangeLog	2012/01/19 23:07:01	183319
@@ -1,3 +1,9 @@
+2012-01-19  Kai Tietz  <ktietz@redhat.com>
+
+	PR c++/51344
+	* decl2.c (save_template_attributes): Use merge_attributes
+	instead of chaining up via TREE_CHAIN.
+
 2011-10-19  Jason Merrill  <jason@redhat.com>
 
 	PR c++/50793
--- gcc-4_4-branch/gcc/cp/decl2.c	2012/01/19 22:57:31	183318
+++ gcc-4_4-branch/gcc/cp/decl2.c	2012/01/19 23:07:01	183319
@@ -1152,9 +1152,9 @@
 
   old_attrs = *q;
 
-  /* Place the late attributes at the beginning of the attribute
+  /* Merge the late attributes at the beginning with the attribute
      list.  */
-  TREE_CHAIN (tree_last (late_attrs)) = *q;
+  late_attrs = merge_attributes (late_attrs, *q);
   *q = late_attrs;
 
   if (!DECL_P (*decl_p) && *decl_p == TYPE_MAIN_VARIANT (*decl_p))
--- gcc-4_4-branch/gcc/testsuite/ChangeLog	2012/01/19 22:57:31	183318
+++ gcc-4_4-branch/gcc/testsuite/ChangeLog	2012/01/19 23:07:01	183319
@@ -1,3 +1,7 @@
+2012-01-19  Kai Tietz  <ktietz@redhat.com>
+
+	* g++.dg/torture/pr51344.C: New test.
+
 2012-01-15  Uros Bizjak  <ubizjak@gmail.com>
 
 	PR rtl-optimization/51821
--- /dev/null
+++ gcc-4_4-branch/gcc/testsuite/g++.dg/torture/pr51344.C
@@ -0,0 +1,11 @@
+/* { dg-do compile } */
+class A;
+
+template <class T>
+class B
+{
+  friend __attribute__((cdecl)) A& operator >>(A& a, B& b)
+  {
+    return a;
+  }
+};
