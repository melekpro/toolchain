[4.6 regression] Invalid dynamic_cast for unnamed namespace

 http://gcc.gnu.org/bugzilla/show_bug.cgi?id=49440

--- gcc-4_5-branch/gcc/testsuite/ChangeLog	(revision 175417)
+++ gcc-4_5-branch/gcc/testsuite/ChangeLog	(revision 175418)
@@ -22,6 +22,11 @@
 	PR tree-optimization/48822
 	* gcc.dg/torture/pr48822.c: New testcase.
 
+2011-06-23  Jason Merrill  <jason@redhat.com>
+
+	PR c++/49440
+	* g++.dg/rtti/anon-ns1.C: New.
+
 2011-05-03  Jakub Jelinek  <jakub@redhat.com>
 
 	Backport from mainline
--- gcc-4_5-branch/gcc/testsuite/g++.dg/rtti/anon-ns1.C	(revision 0)
+++ gcc-4_5-branch/gcc/testsuite/g++.dg/rtti/anon-ns1.C	(revision 175418)
@@ -0,0 +1,15 @@
+// PR c++/49440
+// The typeinfo name for A should start with * so we compare
+// it by address rather than contents.
+
+// { dg-final { scan-assembler "\"\*N\[^\"\]+1AE\"" } }
+
+namespace
+{
+  class A { };
+}
+
+void f()
+{
+  throw A();
+}
--- gcc-4_5-branch/gcc/cp/class.c	(revision 175417)
+++ gcc-4_5-branch/gcc/cp/class.c	(revision 175418)
@@ -681,21 +681,10 @@ get_vtable_name (tree type)
    the abstract.  */
 
 void
-set_linkage_according_to_type (tree type, tree decl)
+set_linkage_according_to_type (tree type ATTRIBUTE_UNUSED, tree decl)
 {
-  /* If TYPE involves a local class in a function with internal
-     linkage, then DECL should have internal linkage too.  Other local
-     classes have no linkage -- but if their containing functions
-     have external linkage, it makes sense for DECL to have external
-     linkage too.  That will allow template definitions to be merged,
-     for example.  */
-  if (no_linkage_check (type, /*relaxed_p=*/true))
-    {
-      TREE_PUBLIC (decl) = 0;
-      DECL_INTERFACE_KNOWN (decl) = 1;
-    }
-  else
-    TREE_PUBLIC (decl) = 1;
+  TREE_PUBLIC (decl) = 1;
+  determine_visibility (decl);
 }
 
 /* Create a VAR_DECL for a primary or secondary vtable for CLASS_TYPE.
--- gcc-4_5-branch/gcc/cp/ChangeLog	(revision 175417)
+++ gcc-4_5-branch/gcc/cp/ChangeLog	(revision 175418)
@@ -1,3 +1,9 @@
+2011-06-23  Jason Merrill  <jason@redhat.com>
+
+	PR c++/49440
+	* class.c (set_linkage_according_to_type): Hand off to
+	determine_visibility.
+
 2011-04-27  Jason Merrill  <jason@redhat.com>
 
 	PR c++/48046
