[4.5 Regression] ICE in gimplify_expr, at gimplify.c:7034

 http://gcc.gnu.org/bugzilla/show_bug.cgi?id=48685

--- gcc-4_5-branch/gcc/fold-const.c	(revision 173323)
+++ gcc-4_5-branch/gcc/fold-const.c	(revision 173324)
@@ -2784,8 +2784,6 @@ fold_convert_loc (location_t loc, tree type, tree
 
     case VOID_TYPE:
       tem = fold_ignored_result (arg);
-      if (TREE_CODE (tem) == MODIFY_EXPR)
-	goto fold_convert_exit;
       return fold_build1_loc (loc, NOP_EXPR, type, tem);
 
     default:
--- gcc-4_5-branch/gcc/ChangeLog	(revision 173323)
+++ gcc-4_5-branch/gcc/ChangeLog	(revision 173324)
@@ -1,3 +1,12 @@
+2011-05-03  Jakub Jelinek  <jakub@redhat.com>
+
+	Backport from mainline
+	2011-04-23  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c/48685
+	* fold-const.c (fold_convert_loc): Add NOP_EXPR when casting
+	to VOID_TYPE even around MODIFY_EXPR.
+
 2011-04-28  Release Manager
 
 	* GCC 4.5.3 released.
--- gcc-4_5-branch/gcc/testsuite/gcc.dg/pr48685.c	(revision 0)
+++ gcc-4_5-branch/gcc/testsuite/gcc.dg/pr48685.c	(revision 173324)
@@ -0,0 +1,11 @@
+/* PR c/48685 */
+/* { dg-do compile } */
+/* { dg-options "-O2" } */
+
+int
+main ()
+{
+  int v = 1;
+  (void) (1 == 2 ? (void) 0 : (v = 0));
+  return v;
+}
--- gcc-4_5-branch/gcc/testsuite/ChangeLog	(revision 173323)
+++ gcc-4_5-branch/gcc/testsuite/ChangeLog	(revision 173324)
@@ -1,3 +1,11 @@
+2011-05-03  Jakub Jelinek  <jakub@redhat.com>
+
+	Backport from mainline
+	2011-04-23  Jakub Jelinek  <jakub@redhat.com>
+
+	PR c/48685
+	* gcc.dg/pr48685.c: New test.
+
 2011-04-27  Jason Merrill  <jason@redhat.com>
 
 	* g++.dg/parse/ambig6.C: New.
